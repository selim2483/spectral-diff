/scratchm/sollivie/spectral-diff/.pixi/envs/default/lib/python3.13/site-packages/lightning/fabric/utilities/seed.py:44: No seed found, seed set to 0
[rank: 0] Seed set to 0
Trainer already configured with model summary callbacks: [<class 'lightning.pytorch.callbacks.model_summary.ModelSummary'>]. Skipping setting a default `ModelSummary` callback.
GPU available: True (cuda), used: True
TPU available: False, using: 0 TPU cores
HPU available: False, using: 0 HPUs
wandb: Currently logged in as: selimollivier24 (selimollivier247) to https://api.wandb.ai. Use `wandb login --relogin` to force relogin
wandb: Tracking run with wandb version 0.23.0
wandb: Run data is saved locally in /scratchm/sollivie/spectral-diff/runs/cloudy_image_512/wandb/run-20251128_134004-9nmodjr5
wandb: Run `wandb offline` to turn off syncing.
wandb: Syncing run cloudy_image_512
wandb: ‚≠êÔ∏è View project at https://wandb.ai/selimollivier247/spectralDiff
wandb: üöÄ View run at https://wandb.ai/selimollivier247/spectralDiff/runs/9nmodjr5
/scratchm/sollivie/spectral-diff/.pixi/envs/default/lib/python3.13/site-packages/lightning/pytorch/callbacks/model_checkpoint.py:751: Checkpoint directory /scratchm/sollivie/spectral-diff/runs/cloudy_image_512 exists and is not empty.
LOCAL_RANK: 0 - CUDA_VISIBLE_DEVICES: [0]

   | Name                        | Type             | Params | Mode  | In sizes                    | Out sizes       
---------------------------------------------------------------------------------------------------------------------------
0  | model                       | UNet             | 5.4 M  | train | ?                           | ?               
1  | model.time_mlp              | Sequential       | 2.1 K  | train | ?                           | ?               
2  | model.time_mlp.0            | SinusoidalPosEmb | 0      | train | ?                           | ?               
3  | model.time_mlp.1            | Linear           | 1.1 K  | train | ?                           | ?               
4  | model.time_mlp.2            | GELU             | 0      | train | ?                           | ?               
5  | model.time_mlp.3            | Linear           | 1.0 K  | train | ?                           | ?               
6  | model.downs                 | ModuleList       | 2.3 M  | train | ?                           | ?               
7  | model.downs.0               | ModuleList       | 34.9 K | train | ?                           | ?               
8  | model.downs.1               | ModuleList       | 133 K  | train | ?                           | ?               
9  | model.downs.2               | ModuleList       | 494 K  | train | ?                           | ?               
10 | model.downs.3               | ModuleList       | 1.6 M  | train | ?                           | ?               
11 | model.ups                   | ModuleList       | 1.2 M  | train | ?                           | ?               
12 | model.ups.0                 | ModuleList       | 911 K  | train | ?                           | ?               
13 | model.ups.1                 | ModuleList       | 241 K  | train | ?                           | ?               
14 | model.ups.2                 | ModuleList       | 67.4 K | train | ?                           | ?               
15 | model.mid_block1            | ConvNextBlock    | 894 K  | train | ?                           | ?               
16 | model.mid_block1.mlp        | Sequential       | 2.2 K  | train | ?                           | ?               
17 | model.mid_block1.ds_conv    | Conv2d           | 6.4 K  | train | ?                           | ?               
18 | model.mid_block1.net        | Sequential       | 885 K  | train | ?                           | ?               
19 | model.mid_block1.res_conv   | Identity         | 0      | train | ?                           | ?               
20 | model.mid_attn              | Residual         | 65.9 K | train | ?                           | ?               
21 | model.mid_attn.fn           | PreNorm          | 65.9 K | train | ?                           | ?               
22 | model.mid_block2            | ConvNextBlock    | 894 K  | train | ?                           | ?               
23 | model.mid_block2.mlp        | Sequential       | 2.2 K  | train | ?                           | ?               
24 | model.mid_block2.ds_conv    | Conv2d           | 6.4 K  | train | ?                           | ?               
25 | model.mid_block2.net        | Sequential       | 885 K  | train | ?                           | ?               
26 | model.mid_block2.res_conv   | Identity         | 0      | train | ?                           | ?               
27 | model.final_conv            | Sequential       | 14.7 K | train | ?                           | ?               
28 | model.final_conv.0          | ConvNextBlock    | 14.7 K | train | ?                           | ?               
29 | model.final_conv.1          | Conv2d           | 17     | train | ?                           | ?               
30 | ema_model                   | EMA              | 5.4 M  | train | [[8, 1, 256, 256], []]      | ?               
31 | ema_model.module            | UNet             | 5.4 M  | eval  | [[8, 1, 256, 256], []]      | ?               
32 | ema_model.module.time_mlp   | Sequential       | 2.1 K  | eval  | [8]                         | [8, 16]         
33 | ema_model.module.downs      | ModuleList       | 2.3 M  | eval  | ?                           | ?               
34 | ema_model.module.ups        | ModuleList       | 1.2 M  | eval  | ?                           | ?               
35 | ema_model.module.mid_block1 | ConvNextBlock    | 894 K  | eval  | [[8, 128, 32, 32], [8, 16]] | [8, 128, 32, 32]
36 | ema_model.module.mid_attn   | Residual         | 65.9 K | eval  | [8, 128, 32, 32]            | [8, 128, 32, 32]
37 | ema_model.module.mid_block2 | ConvNextBlock    | 894 K  | eval  | [[8, 128, 32, 32], [8, 16]] | [8, 128, 32, 32]
38 | ema_model.module.final_conv | Sequential       | 14.7 K | eval  | [8, 16, 256, 256]           | [8, 1, 256, 256]
---------------------------------------------------------------------------------------------------------------------------
10.8 M    Trainable params
0         Non-trainable params
10.8 M    Total params
43.138    Total estimated model params size (MB)
257       Modules in train mode
256       Modules in eval mode
SLURM auto-requeueing enabled. Setting signal handlers.
Traceback (most recent call last):
  File "/scratchm/sollivie/spectral-diff/src/spectral_diff/image.py", line 70, in <module>
    cli_main()
    ~~~~~~~~^^
  File "/scratchm/sollivie/spectral-diff/src/spectral_diff/image.py", line 66, in cli_main
    cli = CustomCLI(
        Diffusion, save_config_kwargs={"overwrite": True})
  File "/scratchm/sollivie/spectral-diff/.pixi/envs/default/lib/python3.13/site-packages/lightning/pytorch/cli.py", line 414, in __init__
    self._run_subcommand(self.subcommand)
    ~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^
  File "/scratchm/sollivie/spectral-diff/.pixi/envs/default/lib/python3.13/site-packages/lightning/pytorch/cli.py", line 747, in _run_subcommand
    fn(**fn_kwargs)
    ~~^^^^^^^^^^^^^
  File "/scratchm/sollivie/spectral-diff/.pixi/envs/default/lib/python3.13/site-packages/lightning/pytorch/trainer/trainer.py", line 560, in fit
    call._call_and_handle_interrupt(
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        self, self._fit_impl, model, train_dataloaders, val_dataloaders, datamodule, ckpt_path
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "/scratchm/sollivie/spectral-diff/.pixi/envs/default/lib/python3.13/site-packages/lightning/pytorch/trainer/call.py", line 49, in _call_and_handle_interrupt
    return trainer_fn(*args, **kwargs)
  File "/scratchm/sollivie/spectral-diff/.pixi/envs/default/lib/python3.13/site-packages/lightning/pytorch/trainer/trainer.py", line 598, in _fit_impl
    self._run(model, ckpt_path=ckpt_path)
    ~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/scratchm/sollivie/spectral-diff/.pixi/envs/default/lib/python3.13/site-packages/lightning/pytorch/trainer/trainer.py", line 1011, in _run
    results = self._run_stage()
  File "/scratchm/sollivie/spectral-diff/.pixi/envs/default/lib/python3.13/site-packages/lightning/pytorch/trainer/trainer.py", line 1053, in _run_stage
    self._run_sanity_check()
    ~~~~~~~~~~~~~~~~~~~~~~^^
  File "/scratchm/sollivie/spectral-diff/.pixi/envs/default/lib/python3.13/site-packages/lightning/pytorch/trainer/trainer.py", line 1082, in _run_sanity_check
    val_loop.run()
    ~~~~~~~~~~~~^^
  File "/scratchm/sollivie/spectral-diff/.pixi/envs/default/lib/python3.13/site-packages/lightning/pytorch/loops/utilities.py", line 179, in _decorator
    return loop_run(self, *args, **kwargs)
  File "/scratchm/sollivie/spectral-diff/.pixi/envs/default/lib/python3.13/site-packages/lightning/pytorch/loops/evaluation_loop.py", line 145, in run
    self._evaluation_step(batch, batch_idx, dataloader_idx, dataloader_iter)
    ~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/scratchm/sollivie/spectral-diff/.pixi/envs/default/lib/python3.13/site-packages/lightning/pytorch/loops/evaluation_loop.py", line 451, in _evaluation_step
    call._call_callback_hooks(trainer, hook_name, output, *hook_kwargs.values())
    ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/scratchm/sollivie/spectral-diff/.pixi/envs/default/lib/python3.13/site-packages/lightning/pytorch/trainer/call.py", line 228, in _call_callback_hooks
    fn(trainer, trainer.lightning_module, *args, **kwargs)
    ~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/scratchm/sollivie/spectral-diff/src/spectral_diff/utils/logging.py", line 335, in on_validation_batch_end
    value = _metric_dict[metric](target, sample, self.options)
  File "/scratchm/sollivie/spectral-diff/src/spectral_diff/metrics.py", line 82, in sliced_wasserstein_distance
    return optimal_transport.sliced_wasserstein_distance(
           ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        target, synth, nslice=options.nhist, batch_size=options.bhist)
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/scratchm/sollivie/spectral-diff/.pixi/envs/default/lib/python3.13/site-packages/texture_metrics/criteria/optimal_transport.py", line 80, in sliced_wasserstein_distance
    return fn(x, y, p=p)**(1/p)
           ~~^^^^^^^^^^^
  File "/scratchm/sollivie/spectral-diff/.pixi/envs/default/lib/python3.13/site-packages/texture_metrics/criteria/slicing.py", line 23, in wrapper
    res.append(fn(xs, ys, *args, **kwargs))
               ~~^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/scratchm/sollivie/spectral-diff/.pixi/envs/default/lib/python3.13/site-packages/texture_metrics/criteria/optimal_transport.py", line 43, in histogram_loss1D
    y_sorted, y_indices = torch.sort(yf)
                          ~~~~~~~~~~^^^^
torch.OutOfMemoryError: CUDA out of memory. Tried to allocate 3.91 GiB. GPU 0 has a total capacity of 23.64 GiB of which 399.56 MiB is free. Including non-PyTorch memory, this process has 23.24 GiB memory in use. Of the allocated memory 19.63 GiB is allocated by PyTorch, and 3.42 GiB is reserved by PyTorch but unallocated. If reserved but unallocated memory is large try setting PYTORCH_CUDA_ALLOC_CONF=expandable_segments:True to avoid fragmentation.  See documentation for Memory Management  (https://pytorch.org/docs/stable/notes/cuda.html#environment-variables)
